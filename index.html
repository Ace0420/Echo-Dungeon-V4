<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Voice Dungeon Explorer</title>
    <style>
        * { box-sizing: border-box; }
        body { 
            margin: 0; padding: 0; background: #000; 
            display: flex; justify-content: center; align-items: center; 
            min-height: 100vh; font-family: Arial, sans-serif; 
            touch-action: manipulation; 
        }
        
        .mic-button {
            width: 95vw; height: 85vh; max-width: 400px; max-height: 400px;
            border-radius: 50%; background: #000; border: 8px solid #fff;
            color: #ffffff; font-size: 32px; font-weight: bold; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            flex-direction: column; text-shadow: 2px 2px 4px #000;
            transition: all 0.2s ease; -webkit-tap-highlight-color: transparent;
        }
        
        .mic-button:active { transform: scale(0.95); }
        .mic-icon { font-size: 80px; margin-bottom: 20px; }
        .listening { background: #000 !important; border-color: #44ff44 !important; }
        
        .start-button { background: #000 !important; border-color: #4444ff !important; }
        
        #debug { 
            position: fixed; top: 10px; left: 10px; color: #fff; font-size: 12px; 
            background: rgba(0,0,0,0.8); padding: 8px; border-radius: 4px; max-width: 280px;
            font-family: monospace; line-height: 1.4;
        }
        
        @media (max-width: 480px) {
            .mic-button { width: 98vw; height: 88vh; font-size: 28px; border: 6px solid #ffffff; }
            .mic-icon { font-size: 70px; margin-bottom: 15px; }
            #debug { font-size: 10px; max-width: 200px; }
        }
    </style>
</head>
<body>
    <div id="debug">Loading Voice Dungeon...</div>
    <button id="micButton" class="mic-button start-button" onclick="handleClick()" aria-label="Voice command button">
        <div class="mic-icon">ðŸŽ¤</div>
        <div id="micText">TAP TO BEGIN</div>
    </button>

    <script>
        const debug = document.getElementById('debug');
        const micButton = document.getElementById('micButton');
        const micText = document.getElementById('micText');
        
        function log(msg) {
            console.log(msg);
            debug.innerHTML = msg + '<br>' + debug.innerHTML.split('<br>').slice(0, 4).join('<br>');
        }
        
        // === AMBIENT SOUND SYSTEM ===
        const ambientSounds = {
            current: null,
            contexts: new Map(),
            
            init() {
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                this.gainNode = this.audioContext.createGain();
                this.gainNode.connect(this.audioContext.destination);
                this.gainNode.gain.value = 0.1;
            },
            
            play(soundType) {
                if (this.current === soundType) return;
                this.current = soundType;
                
                const frequencies = {
                    dungeon: [60, 80],
                    water: [200, 300],
                    wind: [150, 250],
                    fire: [100, 400],
                    merchant: [300, 400]
                };
                
                this.stop();
                
                if (frequencies[soundType] && this.audioContext) {
                    const [freq1, freq2] = frequencies[soundType];
                    
                    const osc1 = this.audioContext.createOscillator();
                    const osc2 = this.audioContext.createOscillator();
                    
                    osc1.frequency.setValueAtTime(freq1, this.audioContext.currentTime);
                    osc2.frequency.setValueAtTime(freq2, this.audioContext.currentTime);
                    
                    osc1.type = 'sine';
                    osc2.type = 'triangle';
                    
                    const lowGain = this.audioContext.createGain();
                    lowGain.gain.value = 0.02;
                    
                    osc1.connect(lowGain);
                    osc2.connect(lowGain);
                    lowGain.connect(this.gainNode);
                    
                    osc1.start();
                    osc2.start();
                    
                    this.contexts.set(soundType, [osc1, osc2, lowGain]);
                }
            },
            
            stop() {
                this.contexts.forEach(([osc1, osc2]) => {
                    try {
                        osc1.stop();
                        osc2.stop();
                    } catch(e) {}
                });
                this.contexts.clear();
            }
        };

        // === ENHANCED GAME STATE ===
        const game = {
            player: { 
                class: '', 
                level: 1,
                experience: 0,
                experienceToNext: 100,
                health: 100, 
                maxHealth: 100, 
                mana: 50,
                maxMana: 50,
                gold: 25,
                inventory: [], 
                position: { x: 0, y: 0 },
                skills: {
                    combat: 1,
                    magic: 1,
                    stealth: 1,
                    crafting: 1,
                    trading: 1
                },
                weapon: null,
                armor: null
            },
            currentRoom: null, 
            map: {}, 
            listening: false, 
            started: false, 
            needsClass: true,
            speechReady: false, 
            initialized: false,
            gameData: null
        };

        const classes = {
            warrior: { 
                name: 'Warrior', 
                health: 120, 
                mana: 30,
                gold: 50,
                items: ['Iron Sword', 'Health Potion', 'Leather Armor'],
                skills: { combat: 2, magic: 1, stealth: 1, crafting: 1, trading: 1 }
            },
            mage: { 
                name: 'Mage', 
                health: 80, 
                mana: 100,
                gold: 75,
                items: ['Magic Staff', 'Mana Potion', 'Cloth Robes'],
                skills: { combat: 1, magic: 3, stealth: 1, crafting: 1, trading: 1 }
            },
            rogue: { 
                name: 'Rogue', 
                health: 100, 
                mana: 60,
                gold: 100,
                items: ['Steel Dagger', 'Lockpicks', 'Studded Leather'],
                skills: { combat: 1, magic: 1, stealth: 3, crafting: 2, trading: 1 }
            }
        };

        const weapons = {
            'Iron Sword': { damage: [8, 15], skill: 'combat', value: 25 },
            'Steel Sword': { damage: [12, 20], skill: 'combat', value: 75 },
            'Magic Staff': { damage: [6, 18], skill: 'magic', value: 50 },
            'Fire Staff': { damage: [10, 25], skill: 'magic', value: 150 },
            'Steel Dagger': { damage: [5, 12], skill: 'stealth', value: 30 },
            'Poison Dagger': { damage: [8, 15], skill: 'stealth', value: 100 }
        };

        const items = {
            'Health Potion': { type: 'healing', value: 30, price: 15 },
            'Mana Potion': { type: 'mana', value: 25, price: 20 },
            'Leather Armor': { type: 'armor', defense: 3, price: 40 },
            'Chain Mail': { type: 'armor', defense: 6, price: 100 },
            'Cloth Robes': { type: 'armor', defense: 1, mana: 10, price: 30 },
            'Lockpicks': { type: 'tool', price: 10 },
            'Crafting Kit': { type: 'tool', price: 50 },
            'Iron Ore': { type: 'material', price: 8 },
            'Magic Crystal': { type: 'material', price: 25 },
            'Gold Coins': { type: 'currency', value: 20 }
        };

        // === SPEECH SYSTEM ===
        function speak(text, callback) {
            log('SPEAK: ' + text.substring(0, 30) + '...');
            
            if (!window.speechSynthesis) {
                log('No speech synthesis available');
                if (callback) setTimeout(callback, 1000);
                return;
            }

            try {
                speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.7;
                utterance.pitch = 1.0;
                utterance.volume = 1.0;
                utterance.lang = 'en-US';
                
                if (callback) {
                    utterance.onend = callback;
                    utterance.onerror = () => {
                        log('Speech error occurred');
                        callback();
                    };
                }
                
                speechSynthesis.speak(utterance);
            } catch (error) {
                log('Speech failed: ' + error.message);
                if (callback) setTimeout(callback, 1000);
            }
        }

        // === VOICE RECOGNITION ===
        let recognition = null;
        
        function startListening() {
            if (!window.webkitSpeechRecognition && !window.SpeechRecognition) {
                log('Voice recognition not supported');
                speak('Voice recognition is not supported on this browser. Please try Chrome or Edge.');
                return;
            }
            
            if (game.listening) {
                stopListening();
                return;
            }

            try {
                const Recognition = window.webkitSpeechRecognition || window.SpeechRecognition;
                recognition = new Recognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';
                recognition.maxAlternatives = 1;

                recognition.onstart = function() {
                    log('Listening started');
                    game.listening = true;
                    micButton.classList.add('listening');
                    micButton.classList.remove('start-button');
                    micText.textContent = 'LISTENING...';
                    speak('Listening for your command...');
                };

                recognition.onresult = function(event) {
                    const command = event.results[0][0].transcript.toLowerCase().trim();
                    const confidence = Math.round(event.results[0][0].confidence * 100);
                    log(`HEARD: "${command}" (${confidence}%)`);
                    
                    stopListening();
                    setTimeout(() => processCommand(command), 500);
                };

                recognition.onerror = function(event) {
                    log('Voice error: ' + event.error);
                    stopListening();
                    
                    switch(event.error) {
                        case 'not-allowed':
                            speak('Microphone permission was denied. Please allow microphone access and refresh the page.');
                            break;
                        case 'no-speech':
                            speak('I did not hear any speech. Please speak closer to the microphone and try again.');
                            break;
                        default:
                            speak('Voice recognition error occurred. Please try speaking again.');
                    }
                };

                recognition.onend = function() {
                    stopListening();
                };

                recognition.start();

            } catch (error) {
                log('Recognition setup failed: ' + error.message);
                speak('Failed to start voice recognition. Please try again.');
                stopListening();
            }
        }

        function stopListening() {
            game.listening = false;
            micButton.classList.remove('listening');
            micText.textContent = 'SPEAK';
            
            if (recognition) {
                try {
                    recognition.stop();
                } catch (e) {}
                recognition = null;
            }
        }

        // === INITIALIZATION ===
        function initializeGame() {
            log('Initializing voice dungeon...');
            
            ambientSounds.init();
            
            speak(' ', () => {
                game.speechReady = true;
                game.initialized = true;
                
                micButton.classList.remove('start-button');
                micText.textContent = 'SPEAK';
                
                const welcome = "Welcome to the Voice Dungeon Explorer. " +
                    "This is an audio-only adventure designed for blind players. " +
                    "Everything happens through sound and voice commands. " +
                    "Choose your class: Say warrior for combat mastery, mage for magical power, or rogue for stealth and cunning.";
                
                speak(welcome, () => {
                    log('Voice dungeon ready - waiting for class selection');
                    ambientSounds.play('dungeon');
                });
            });
        }

        function handleClick() {
            if (!game.initialized) {
                initializeGame();
            } else {
                startListening();
            }
        }

        // === COMMAND PROCESSING ===
        function processCommand(command) {
            log('PROCESSING: ' + command);
            
            // Class selection
            if (game.needsClass) {
                if (command.includes('warrior') || command.includes('fighter')) {
                    selectClass('warrior');
                } else if (command.includes('mage') || command.includes('wizard') || command.includes('magic')) {
                    selectClass('mage');
                } else if (command.includes('rogue') || command.includes('thief') || command.includes('sneak')) {
                    selectClass('rogue');
                } else {
                    speak('Please say warrior, mage, or rogue to choose your character class.');
                }
                return;
            }

            if (!game.started) return;

            // Movement
            if (command.includes('north') || command.includes('forward') || command.includes('ahead')) {
                movePlayer('north');
            } else if (command.includes('south') || command.includes('back') || command.includes('backward')) {
                movePlayer('south');
            } else if (command.includes('east') || command.includes('right')) {
                movePlayer('east');
            } else if (command.includes('west') || command.includes('left')) {
                movePlayer('west');
            }
            
            // Combat
            else if (command.includes('attack') || command.includes('fight') || command.includes('battle') || command.includes('hit')) {
                if (game.currentRoom && game.currentRoom.enemy) {
                    combat();
                } else {
                    speak('There is nothing here to fight.');
                }
            }
            
            // Magic
            else if (command.includes('cast') || command.includes('spell') || command.includes('magic')) {
                castSpell();
            }
            
            // Stealth
            else if (command.includes('sneak') || command.includes('hide') || command.includes('stealth')) {
                usestealth();
            }
            
            // Exploration
            else if (command.includes('search') || command.includes('look') || command.includes('examine') || command.includes('explore')) {
                searchRoom();
            }
            
            // Inventory and equipment
            else if (command.includes('inventory') || command.includes('items') || command.includes('equipment') || command.includes('gear')) {
                listInventory();
            } else if (command.includes('equip') || command.includes('wield') || command.includes('wear')) {
                equipItem(command);
            } else if (command.includes('use') && (command.includes('potion') || command.includes('health') || command.includes('mana'))) {
                usePotion(command);
            }
            
            // Trading
            else if (command.includes('trade') || command.includes('buy') || command.includes('sell') || command.includes('merchant') || command.includes('shop')) {
                if (game.currentRoom && game.currentRoom.merchant) {
                    handleTrading(command);
                } else {
                    speak('There is no merchant here to trade with.');
                }
            }
            
            // Crafting
            else if (command.includes('craft') || command.includes('make') || command.includes('create')) {
                handleCrafting(command);
            }
            
            // Character progression
            else if (command.includes('level') && (command.includes('up') || command.includes('skill'))) {
                levelUpSkill(command);
            } else if (command.includes('status') || command.includes('stats') || command.includes('character')) {
                characterStatus();
            } else if (command.includes('skills')) {
                listSkills();
            }
            
            // Save/Load
            else if (command.includes('save') && command.includes('game')) {
                saveGame();
            } else if (command.includes('load') && command.includes('game')) {
                loadGame();
            }
            
            // Help
            else if (command.includes('help') || command.includes('command') || command.includes('what can i do')) {
                speak('Available commands: Move north south east west. Attack to fight. Cast spell for magic. Sneak for stealth. Search room. Say inventory for items. Equip weapons armor. Use health potion or mana potion. Trade buy sell with merchants. Craft at stations. Level up combat magic stealth crafting trading. Status for character info. Skills to hear skill levels. Save game. Load game. Say help again for more details.');
            }
            
            // Unknown command
            else {
                speak('I do not understand that command. Say help to hear what you can do.');
            }
        }

        // === GAME LOGIC ===
        function selectClass(className) {
            const classData = classes[className];
            game.player.class = className;
            game.player.health = classData.health;
            game.player.maxHealth = classData.health;
            game.player.mana = classData.mana;
            game.player.maxMana = classData.mana;
            game.player.gold = classData.gold;
            game.player.inventory = [...classData.items];
            game.player.skills = { ...classData.skills };
            
            // Auto-equip starting gear
            game.player.weapon = classData.items[0];
            game.player.armor = classData.items[2];
            
            game.needsClass = false;
            game.started = true;
            game.map = createEnhancedMap();
            
            const message = `You are now a level ${game.player.level} ${classData.name}. ` +
                `You have ${classData.health} health, ${classData.mana} mana, and ${classData.gold} gold coins. ` +
                `You are equipped with ${game.player.weapon} and ${game.player.armor}. ` +
                `Your skills include combat level ${game.player.skills.combat}, magic level ${game.player.skills.magic}, stealth level ${game.player.skills.stealth}, crafting level ${game.player.skills.crafting}, and trading level ${game.player.skills.trading}. ` +
                `Say go north to begin your adventure.`;
            
            speak(message, () => {
                setTimeout(() => enterRoom(0, 0), 4000);
            });
        }

        function createEnhancedMap() {
            return {
                '0,0': {
                    description: 'You stand at the dungeon entrance. Ancient runes glow faintly on the stone walls. The air hums with magical energy. Passages lead north and east.',
                    enemy: null,
                    treasure: null,
                    merchant: null,
                    ambience: 'dungeon',
                    visited: true
                },
                '0,1': {
                    description: 'A damp chamber with mystical properties. Water droplets sparkle with magical residue. Strange symbols pulse with ethereal light on the ceiling.',
                    enemy: null,
                    treasure: 'Magic Crystal',
                    merchant: null,
                    ambience: 'water',
                    visited: false
                },
                '1,0': {
                    description: 'A narrow corridor where shadows dance menacingly. The walls are scarred from previous battles. You sense danger lurking ahead.',
                    enemy: { name: 'Shadow Goblin', health: 30, maxHealth: 30, level: 1, experience: 25, gold: 15 },
                    treasure: null,
                    merchant: null,
                    ambience: 'dungeon',
                    visited: false
                },
                '1,1': {
                    description: 'The merchant\'s rest area. Colorful banners hang from the ceiling and the scent of exotic spices fills the air. A friendly trader awaits customers.',
                    enemy: null,
                    treasure: null,
                    merchant: {
                        name: 'Gareth the Trader',
                        inventory: {
                            'Steel Sword': { price: 75, stock: 1 },
                            'Fire Staff': { price: 150, stock: 1 },
                            'Chain Mail': { price: 100, stock: 2 },
                            'Health Potion': { price: 15, stock: 5 },
                            'Mana Potion': { price: 20, stock: 3 },
                            'Crafting Kit': { price: 50, stock: 1 }
                        }
                    },
                    ambience: 'merchant',
                    visited: false
                },
                '0,2': {
                    description: 'A mystical forge room. Ancient anvils and magical flames provide an otherworldly workshop. This is the perfect place for crafting enhanced equipment.',
                    enemy: null,
                    treasure: 'Iron Ore',
                    merchant: null,
                    ambience: 'fire',
                    craftingStation: true,
                    visited: false
                },
                '2,0': {
                    description: 'A windswept chamber with holes in the ceiling. Gusts of air create an eerie whistling sound. A formidable guardian blocks the passage beyond.',
                    enemy: { name: 'Wind Spirit', health: 50, maxHealth: 50, level: 2, experience: 50, gold: 35 },
                    treasure: 'Enchanted Ring',
                    merchant: null,
                    ambience: 'wind',
                    visited: false
                }
            };
        }

        function movePlayer(direction) {
            const pos = game.player.position;
            let newX = pos.x, newY = pos.y;
            
            if (direction === 'north') newY += 1;
            else if (direction === 'south') newY -= 1;
            else if (direction === 'east') newX += 1;
            else if (direction === 'west') newX -= 1;
            
            const roomKey = `${newX},${newY}`;
            const room = game.map[roomKey];
            
            if (room) {
                game.player.position = { x: newX, y: newY };
                speak(`You move ${direction}.`, () => {
                    setTimeout(() => enterRoom(newX, newY), 1500);
                });
            } else {
                speak('You cannot go that way. There is a solid wall blocking your path.');
            }
        }

        function enterRoom(x, y) {
            const roomKey = `${x},${y}`;
            const room = game.map[roomKey];
            game.currentRoom = room;
            
            // Change ambient sound
            ambientSounds.play(room.ambience);
            
            // Remove all visual feedback - pure audio only
            micButton.classList.remove('listening', 'merchant', 'levelup');
            micText.textContent = 'SPEAK';
            
            if (!room.visited) {
                room.visited = true;
                speak(room.description, () => {
                    setTimeout(() => {
                        if (room.enemy) {
                            speak(`A level ${room.enemy.level} ${room.enemy.name} blocks your path! It has ${room.enemy.health} health. Say attack to fight, cast spell to use magic, or sneak to try stealth!`);
                        } else if (room.merchant) {
                            speak(`${room.merchant.name} greets you warmly. Say trade, buy, or sell to do business. Available items include weapons, armor, and potions.`);
                        } else if (room.craftingStation) {
                            speak('You have found a crafting station! Say craft to create new items from your materials. You will need a crafting kit and materials.');
                        } else if (room.treasure) {
                            speak('You notice something valuable in this room. Say search to investigate thoroughly.');
                        } else {
                            speak('This room appears empty but peaceful. You can continue exploring in other directions.');
                        }
                    }, 3000);
                });
            } else {
                speak('You return to a familiar room.', () => {
                    if (room.enemy) {
                        setTimeout(() => speak(`The ${room.enemy.name} is still here, ready to fight!`), 1000);
                    } else if (room.merchant) {
                        setTimeout(() => speak(`${room.merchant.name} welcomes you back.`), 1000);
                    }
                });
            }
        }

        function combat() {
            const enemy = game.currentRoom.enemy;
            if (!enemy) return;
            
            const weapon = weapons[game.player.weapon];
            const baseSkill = game.player.skills.combat;
            const skillBonus = Math.floor(baseSkill * 2);
            const [minDmg, maxDmg] = weapon.damage;
            const playerDamage = Math.floor(Math.random() * (maxDmg - minDmg + 1)) + minDmg + skillBonus;
            
            const enemyDamage = Math.floor(Math.random() * 10) + 5 + (enemy.level * 2);
            
            enemy.health -= playerDamage;
            
            if (enemy.health <= 0) {
                const expGained = enemy.experience;
                const goldGained = enemy.gold;
                game.player.experience += expGained;
                game.player.gold += goldGained;
                
                speak(`You strike the ${enemy.name} with your ${game.player.weapon} for ${playerDamage} damage! The creature falls defeated!`, () => {
                    game.currentRoom.enemy = null;
                    setTimeout(() => {
                        speak(`You gain ${expGained} experience and ${goldGained} gold coins! Your combat skill improves with practice.`);
                        improveskill('combat');
                        checkLevelUp();
                    }, 2000);
                });
            } else {
                speak(`You attack the ${enemy.name} with your ${game.player.weapon} for ${playerDamage} damage! It now has ${enemy.health} health remaining.`, () => {
                    game.player.health -= enemyDamage;
                    setTimeout(() => {
                        speak(`The ${enemy.name} strikes back for ${enemyDamage} damage! Your health is now ${game.player.health}.`, () => {
                            if (game.player.health <= 0) {
                                setTimeout(() => {
                                    speak('You have been defeated! You awaken back at the entrance, but you keep your experience and items. Your health is restored.', () => {
                                        game.player.health = game.player.maxHealth;
                                        game.player.position = { x: 0, y: 0 };
                                        setTimeout(() => enterRoom(0, 0), 3000);
                                    });
                                }, 1500);
                            }
                        });
                    }, 2000);
                });
            }
        }

        function castSpell() {
            if (game.player.mana < 10) {
                speak('You do not have enough mana to cast a spell. You need at least 10 mana.');
                return;
            }
            
            const enemy = game.currentRoom.enemy;
            if (!enemy) {
                speak('There is nothing here to cast a spell on.');
                return;
            }
            
            game.player.mana -= 10;
            const magicSkill = game.player.skills.magic;
            const spellDamage = Math.floor(Math.random() * 15) + 10 + (magicSkill * 3);
            
            enemy.health -= spellDamage;
            
            speak(`You cast a magical spell for ${spellDamage} damage! Your mana is now ${game.player.mana}.`, () => {
                if (enemy.health <= 0) {
                    setTimeout(() => {
                        const expGained = enemy.experience;
                        const goldGained = enemy.gold;
                        game.player.experience += expGained;
                        game.player.gold += goldGained;
                        game.currentRoom.enemy = null;
                        
                        speak(`The ${enemy.name} is defeated by your magic! You gain ${expGained} experience and ${goldGained} gold. Your magical abilities grow stronger!`);
                        improveskill('magic');
                        checkLevelUp();
                    }, 1500);
                }
            });
        }

        function usestealth() {
            const enemy = game.currentRoom.enemy;
            if (!enemy) {
                speak('There is nothing here requiring stealth.');
                return;
            }
            
            const stealthSkill = game.player.skills.stealth;
            const stealthChance = 30 + (stealthSkill * 15);
            
            if (Math.random() * 100 < stealthChance) {
                const sneakDamage = Math.floor(Math.random() * 20) + 15 + (stealthSkill * 2);
                enemy.health -= sneakDamage;
                
                speak(`You successfully sneak attack the ${enemy.name} for ${sneakDamage} damage! Your stealth skills improve.`, () => {
                    if (enemy.health <= 0) {
                        const expGained = enemy.experience + 10;
                        const goldGained = enemy.gold;
                        game.player.experience += expGained;
                        game.player.gold += goldGained;
                        game.currentRoom.enemy = null;
                        
                        speak(`Your stealth attack defeats the ${enemy.name}! You gain ${expGained} experience and ${goldGained} gold.`, () => {
                            improveskill('stealth');
                            checkLevelUp();
                        });
                    }
                });
            } else {
                speak(`Your stealth attempt fails! The ${enemy.name} spots you and attacks!`, () => {
                    const enemyDamage = Math.floor(Math.random() * 12) + 8 + (enemy.level * 2);
                    game.player.health -= enemyDamage;
                    setTimeout(() => {
                        speak(`You take ${enemyDamage} damage! Your health is now ${game.player.health}.`);
                        if (game.player.health <= 0) {
                            setTimeout(() => {
                                speak('You have been defeated! You awaken back at the entrance, but you keep your experience and items. Your health is restored.', () => {
                                    game.player.health = game.player.maxHealth;
                                    game.player.position = { x: 0, y: 0 };
                                    setTimeout(() => enterRoom(0, 0), 3000);
                                });
                            }, 1500);
                        }
                    }, 2000);
                });
            }
        }

        function searchRoom() {
            const room = game.currentRoom;
            if (room.treasure && !room.searched) {
                room.searched = true;
                const treasure = items[room.treasure];
                game.player.inventory.push(room.treasure);
                speak(`You find a ${room.treasure}! You add it to your inventory.`, () => {
                    if (treasure.type === 'material') {
                        setTimeout(() => speak(`This ${room.treasure} could be valuable for crafting or trading.`), 2000);
                    } else {
                        setTimeout(() => speak(`This item might be useful in your adventures.`), 2000);
                    }
                });
            } else if (room.treasure) {
                speak('You search the room but find nothing new. You already discovered the treasure here.');
            } else {
                speak('You carefully search the room but find nothing of value.');
            }
        }

        function listInventory() {
            if (game.player.inventory.length === 0) {
                speak('Your inventory is empty.');
                return;
            }
            
            const weaponsInInv = game.player.inventory.filter(item => weapons[item]);
            const otherItems = game.player.inventory.filter(item => !weapons[item]);
            
            let message = `You have ${game.player.gold} gold coins. `;
            
            if (weaponsInInv.length > 0) {
                message += `Weapons: ${weaponsInInv.join(', ')}. `;
            }
            
            if (otherItems.length > 0) {
                message += `Items: ${otherItems.join(', ')}. `;
            }
            
            if (game.player.weapon) {
                message += `You are wielding ${game.player.weapon}. `;
            }
            
            if (game.player.armor) {
                message += `You are wearing ${game.player.armor}.`;
            }
            
            speak(message);
        }

        function equipItem(command) {
            const itemName = extractItemName(command);
            const item = game.player.inventory.find(i => i.toLowerCase().includes(itemName.toLowerCase()));
            
            if (!item) {
                speak('You do not have that item in your inventory.');
                return;
            }
            
            if (weapons[item]) {
                game.player.weapon = item;
                speak(`You equip your ${item}. Your attacks will now use its damage range.`);
            } else if (items[item] && items[item].type === 'armor') {
                game.player.armor = item;
                speak(`You wear your ${item}. It provides additional protection.`);
            } else {
                speak('That item cannot be equipped.');
            }
        }

        function usePotion(command) {
            let potionType = 'health';
            if (command.includes('mana')) potionType = 'mana';
            
            const potion = game.player.inventory.find(item => 
                item.toLowerCase().includes(potionType) && items[item] && items[item].type === potionType
            );
            
            if (!potion) {
                speak(`You do not have a ${potionType} potion.`);
                return;
            }
            
            const potionData = items[potion];
            const index = game.player.inventory.indexOf(potion);
            game.player.inventory.splice(index, 1);
            
            if (potionType === 'health') {
                const healAmount = Math.min(potionData.value, game.player.maxHealth - game.player.health);
                game.player.health = Math.min(game.player.maxHealth, game.player.health + healAmount);
                speak(`You drink the ${potion} and restore ${healAmount} health. Your health is now ${game.player.health}.`);
            } else {
                const manaAmount = Math.min(potionData.value, game.player.maxMana - game.player.mana);
                game.player.mana = Math.min(game.player.maxMana, game.player.mana + manaAmount);
                speak(`You drink the ${potion} and restore ${manaAmount} mana. Your mana is now ${game.player.mana}.`);
            }
        }

        function handleTrading(command) {
            const merchant = game.currentRoom.merchant;
            
            if (command.includes('buy')) {
                handleBuying(command);
            } else if (command.includes('sell')) {
                handleSelling(command);
            } else {
                listMerchantInventory();
            }
        }

        function listMerchantInventory() {
            const merchant = game.currentRoom.merchant;
            let message = `${game.currentRoom.merchant.name} has these items for sale: `;
            
            const availableItems = Object.entries(merchant.inventory)
                .filter(([name, data]) => data.stock > 0)
                .map(([name, data]) => `${name} for ${data.price} gold`);
            
            if (availableItems.length === 0) {
                message += 'Nothing is currently available.';
            } else {
                message += availableItems.join(', ');
            }
            
            message += `. Say "buy [item name]" to purchase or "sell [item name]" to sell.`;
            
            speak(message);
        }

        function handleBuying(command) {
            const merchant = game.currentRoom.merchant;
            const itemName = extractItemName(command);
            const itemData = Object.entries(merchant.inventory).find(([name]) => 
                name.toLowerCase().includes(itemName.toLowerCase())
            );
            
            if (!itemData) {
                speak('That item is not available from this merchant.');
                return;
            }
            
            const [itemNameFull, itemInfo] = itemData;
            if (itemInfo.stock === 0) {
                speak('That item is currently out of stock.');
                return;
            }
            
            if (game.player.gold < itemInfo.price) {
                speak(`You need ${itemInfo.price} gold to buy that. You only have ${game.player.gold} gold.`);
                return;
            }
            
            game.player.gold -= itemInfo.price;
            game.player.inventory.push(itemNameFull);
            itemInfo.stock -= 1;
            
            const tradingSkill = game.player.skills.trading;
            const hagglingBonus = Math.floor(Math.random() * tradingSkill) * 2;
            
            speak(`You buy the ${itemNameFull} for ${itemInfo.price - hagglingBonus} gold! Your trading skills help you get a good deal.`, () => {
                if (hagglingBonus > 0) {
                    setTimeout(() => speak(`Your trading skill saves you ${hagglingBonus} gold!`), 2000);
                    improveskill('trading');
                }
            });
        }

        function handleSelling(command) {
            const itemName = extractItemName(command);
            const item = game.player.inventory.find(i => i.toLowerCase().includes(itemName.toLowerCase()));
            
            if (!item) {
                speak('You do not have that item to sell.');
                return;
            }
            
            const baseValue = items[item] ? items[item].price : 10;
            const tradingSkill = game.player.skills.trading;
            const sellPrice = Math.floor(baseValue * (0.6 + (tradingSkill * 0.1)));
            
            game.player.gold += sellPrice;
            const index = game.player.inventory.indexOf(item);
            game.player.inventory.splice(index, 1);
            
            speak(`You sell the ${item} for ${sellPrice} gold coins. Your trading reputation grows.`);
            improveskill('trading');
        }

        function handleCrafting(command) {
            if (!game.currentRoom.craftingStation) {
                speak('You need to be at a crafting station to craft items.');
                return;
            }
            
            if (!game.player.inventory.includes('Crafting Kit')) {
                speak('You need a crafting kit to use the crafting station.');
                return;
            }
            
            const materials = game.player.inventory.filter(item => 
                items[item] && items[item].type === 'material'
            );
            
            if (materials.length === 0) {
                speak('You need crafting materials to create items. Try finding iron ore or magic crystals.');
                return;
            }
            
            const craftingSkill = game.player.skills.crafting;
            const successChance = 50 + (craftingSkill * 10);
            
            if (Math.random() * 100 < successChance) {
                const craftedItems = ['Steel Sword', 'Health Potion', 'Mana Potion', 'Chain Mail'];
                const craftedItem = craftedItems[Math.floor(Math.random() * craftedItems.length)];
                
                const oreIndex = game.player.inventory.indexOf('Iron Ore');
                const crystalIndex = game.player.inventory.indexOf('Magic Crystal');
                
                if (oreIndex > -1) game.player.inventory.splice(oreIndex, 1);
                if (crystalIndex > -1) game.player.inventory.splice(crystalIndex, 1);
                
                game.player.inventory.push(craftedItem);
                
                speak(`Success! You craft a ${craftedItem} using your materials and crafting skills! Your crafting ability improves.`, () => {
                    improveskill('crafting');
                });
            } else {
                speak(`Your crafting attempt fails. Your skills need more practice. Keep gathering materials and try again!`);
            }
        }

        function levelUpSkill(command) {
            const skillName = extractSkillName(command);
            if (!skillName || !game.player.skills[skillName]) {
                speak('Please specify a valid skill: combat, magic, stealth, crafting, or trading.');
                return;
            }
            
            const currentLevel = game.player.skills[skillName];
            if (currentLevel >= 5) {
                speak(`Your ${skillName} skill is already at maximum level!`);
                return;
            }
            
            const cost = (currentLevel + 1) * 25;
            if (game.player.experience < cost) {
                speak(`Leveling up your ${skillName} skill requires ${cost} experience. You have ${game.player.experience} experience.`);
                return;
            }
            
            game.player.experience -= cost;
            game.player.skills[skillName] += 1;
            
            speak(`You spend ${cost} experience to improve your ${skillName} skill to level ${game.player.skills[skillName]}! This will enhance your abilities in combat, magic, and more.`);
        }

        function characterStatus() {
            const player = game.player;
            const weaponData = player.weapon ? weapons[player.weapon] : null;
            const armorData = player.armor ? items[player.armor] : null;
            
            let message = `You are a level ${player.level} ${classes[player.class].name}. `;
            message += `Health: ${player.health}/${player.maxHealth}, Mana: ${player.mana}/${player.maxMana}, Gold: ${player.gold}. `;
            message += `Experience: ${player.experience}/${player.experienceToNext}. `;
            
            if (weaponData) {
                message += `Weapon: ${player.weapon} (${weaponData.damage[0]}-${weaponData.damage[1]} damage). `;
            }
            
            if (armorData) {
                message += `Armor: ${player.armor} (+${armorData.defense || 0} defense).`;
            }
            
            speak(message);
        }

        function listSkills() {
            const skills = game.player.skills;
            const message = `Your skills: Combat ${skills.combat}, Magic ${skills.magic}, Stealth ${skills.stealth}, Crafting ${skills.crafting}, Trading ${skills.trading}. `;
            message += `Higher skill levels improve your effectiveness in combat, magic, crafting, and trading. Say "level up [skill]" to improve a skill.`;
            speak(message);
        }

        // === UTILITY FUNCTIONS ===
        function extractItemName(command) {
            const words = command.toLowerCase().split(' ');
            const itemKeywords = ['sword', 'staff', 'dagger', 'potion', 'armor', 'mail', 'robes', 'kit', 'ore', 'crystal'];
            
            for (let keyword of itemKeywords) {
                if (command.toLowerCase().includes(keyword)) {
                    return itemKeywords.find(k => k === keyword) || '';
                }
            }
            return '';
        }

        function extractSkillName(command) {
            if (command.includes('combat') || command.includes('fight')) return 'combat';
            if (command.includes('magic') || command.includes('spell')) return 'magic';
            if (command.includes('stealth') || command.includes('sneak')) return 'stealth';
            if (command.includes('craft') || command.includes('make')) return 'crafting';
            if (command.includes('trade') || command.includes('sell') || command.includes('buy')) return 'trading';
            return null;
        }

        function improveskill(skillType) {
            if (Math.random() < 0.3) {
                const currentLevel = game.player.skills[skillType];
                if (currentLevel < 5) {
                    game.player.skills[skillType] += 1;
                    log(`Skill improved: ${skillType} now level ${currentLevel + 1}`);
                }
            }
        }

        function checkLevelUp() {
            if (game.player.experience >= game.player.experienceToNext) {
                game.player.level += 1;
                game.player.experience -= game.player.experienceToNext;
                game.player.experienceToNext = Math.floor(game.player.experienceToNext * 1.5);
                
                // Level up benefits
                game.player.maxHealth += 20;
                game.player.health = game.player.maxHealth;
                game.player.maxMana += 10;
                game.player.mana = game.player.maxMana;
                
                // NO VISUAL FEEDBACK - only audio
                speak(`LEVEL UP! You reach level ${game.player.level}! Your health and mana are fully restored, and you feel much stronger!`, () => {
                    setTimeout(() => speak(`Say "status" to hear your improved character stats.`), 3000);
                });
            }
        }

        // === SAVE/LOAD SYSTEM ===
        function saveGame() {
            const saveData = {
                player: { ...game.player },
                position: { ...game.player.position },
                currentRoomKey: `${game.player.position.x},${game.player.position.y}`,
                map: { ...game.map }
            };
            
            try {
                localStorage.setItem('voiceDungeonSave', JSON.stringify(saveData));
                speak('Your game has been saved successfully!');
            } catch (error) {
                log('Save failed: ' + error.message);
                speak('Failed to save game. Please try again.');
            }
        }

        function loadGame() {
            try {
                const saved = localStorage.getItem('voiceDungeonSave');
                if (!saved) {
                    speak('No saved game found.');
                    return;
                }
                
                const saveData = JSON.parse(saved);
                Object.assign(game.player, saveData.player);
                game.player.position = { ...saveData.position };
                game.map = { ...saveData.map };
                game.currentRoom = game.map[saveData.currentRoomKey];
                game.needsClass = false;
                game.started = true;
                
                speak('Game loaded successfully! You return to where you left off.', () => {
                    setTimeout(() => enterRoom(game.player.position.x, game.player.position.y), 2000);
                });
            } catch (error) {
                log('Load failed: ' + error.message);
                speak('Failed to load game. Starting new adventure.');
            }
        }

        // === EVENT LISTENERS ===
        document.addEventListener('DOMContentLoaded', function() {
            log('Voice Dungeon Explorer loaded');
        });

        // Handle visibility change to pause/resume audio
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                ambientSounds.stop();
            } else if (game.started && game.currentRoom) {
                ambientSounds.play(game.currentRoom.ambience);
            }
        });

        // Prevent context menu on long press for mobile
        micButton.addEventListener('contextmenu', function(e) {
            e.preventDefault();
        });

        // === INITIALIZE ===
        // Game will initialize on first button click via handleClick()
    </script>
</body>
</html>
